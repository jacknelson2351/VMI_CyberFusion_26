<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Big Stein (The Penetrator)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
/*  Reset & Base  */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:       #1a1a1a;
  --bg1:      #212121;
  --bg2:      #2a2a2a;
  --bg3:      #333333;
  --border:   #363636;
  --border2:  #454545;
  --accent:   #d97357;
  --accent-dim:#7a3d2e;
  --amber:    #e8a04c;
  --red:      #e05c6b;
  --blue:     #5b9cf6;
  --cyan:     #2dd4bf;
  --purple:   #a78bfa;
  --text:     #e8e8e8;
  --text-dim: #a0a0a0;
  --text-muted: #606060;

  --cat-pwn:      #e05c6b;
  --cat-web:      #2dd4bf;
  --cat-crypto:   #e8c44c;
  --cat-forensics:#7ed56f;
  --cat-rev:      #f09cb4;
  --cat-misc:     #a78bfa;
  --cat-osint:    #ffd700;
  --cat-network:  #5b9cf6;

  --font-mono: ui-monospace, 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --radius:   8px;
  --radius-lg:12px;
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-sans);
  overflow: hidden;
}

/*  Scrollbar  */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 99px; }

/*  Layout  */
#app { height: 100vh; display: flex; flex-direction: column; }

/*  Topbar  */
#topbar {
  height: 52px;
  background: var(--bg1);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 16px;
  flex-shrink: 0;
  position: relative;
  z-index: 100;
}

#topbar-logo {
  font-family: var(--font-sans);
  font-weight: 700;
  font-size: 15px;
  letter-spacing: 0;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 8px;
}
#topbar-logo .brand-name {
  font-family: var(--font-sans);
  font-size: 14px;
  font-weight: 600;
  line-height: 1;
  white-space: nowrap;
}
#topbar-logo .sep { color: var(--border2); }
#topbar-title { color: var(--text-dim); font-size: 13px; font-weight: 400; }

#topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }

.status-pill {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 12px;
  border-radius: 99px;
  font-family: var(--font-mono);
  font-size: 11px;
  border: 1px solid var(--border2);
  background: var(--bg2);
  color: #fff;
}
.status-pill .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); }
.status-pill.ok .dot   { background: var(--cyan); }
.status-pill.warn .dot { background: var(--amber); }
.status-pill.err .dot  { background: var(--amber); }
#docker-menu-wrap { position: relative; }
#docker-status { cursor: pointer; }
#docker-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  width: 430px;
  max-width: min(92vw, 430px);
  background: var(--bg1);
  border: 1px solid var(--border2);
  border-radius: 10px;
  box-shadow: 0 14px 28px rgba(0,0,0,0.45);
  padding: 10px;
  display: none;
  z-index: 450;
}
#docker-menu.open { display: block; }
.docker-menu-title {
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  margin-bottom: 8px;
}

/*  Buttons  */
.btn {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 7px 16px;
  border-radius: var(--radius);
  font-family: var(--font-sans);
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
  white-space: nowrap;
}
.btn:disabled { opacity: 0.35; cursor: not-allowed; }

.btn-primary   { background: var(--accent); color: #fff; }
.btn-primary:hover:not(:disabled) { background: #e8845f; box-shadow: 0 2px 8px rgba(217,115,87,0.3); }

.btn-amber     { background: var(--amber); color: #000; }
.btn-amber:hover:not(:disabled) { background: #f0b060; }

.btn-ghost     { background: var(--bg3); color: var(--text); border: 1px solid var(--border2); }
.btn-ghost:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }

.btn-danger    { background: rgba(255,77,109,0.15); color: var(--red); border: 1px solid rgba(255,77,109,0.3); }
.btn-danger:hover:not(:disabled) { background: rgba(255,77,109,0.25); }

.btn-sm { padding: 5px 12px; font-size: 12px; }
.btn-icon { padding: 7px 10px; }

/*  Views  */
.view { display: none; flex: 1; overflow: hidden; }
.view.active { display: flex; flex-direction: column; }

/*  Dashboard  */
#view-dashboard { flex-direction: column; }

#dash-header {
  padding: 20px 24px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

#dash-header h1 {
  font-family: var(--font-mono);
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 0;
  font-stretch: 100%;
  text-transform: none;
  color: #fff;
}
.dash-solved {
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--bg2);
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  color: var(--text-dim);
  cursor: pointer;
  transition: all 0.15s;
}
.dash-solved:hover { border-color: var(--border2); color: var(--text); }
.dash-solved:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

.dash-cost {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--bg2);
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
}
.dash-cost .label { letter-spacing: 0.12em; color: var(--text-muted); font-weight: 700; }
.dash-cost .value { color: #fff; font-weight: 700; }
.dash-cost .tokens { color: var(--text-dim); }

.filter-tabs {
  display: flex;
  gap: 4px;
  margin-left: 8px;
  flex-wrap: wrap;
}

.filter-tab {
  padding: 5px 13px;
  border-radius: 99px;
  font-size: 12px;
  font-weight: 700;
  font-family: var(--font-mono);
  cursor: pointer;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-dim);
  transition: all 0.15s;
  letter-spacing: 0.04em;
}
.filter-tab:hover { border-color: var(--border2); color: var(--text); }
.filter-tab.active { border-color: var(--accent); color: var(--accent); background: rgba(217,115,87,0.08); }
.filter-toggle {
  margin-left: 8px;
  padding: 5px 13px;
  border-radius: 99px;
  font-size: 12px;
  font-weight: 700;
  font-family: var(--font-mono);
  cursor: pointer;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-dim);
  transition: all 0.15s;
  letter-spacing: 0.04em;
}
.filter-toggle:hover { border-color: var(--border2); color: var(--text); }
.filter-toggle.active { border-color: var(--cyan); color: var(--cyan); background: rgba(45,212,191,0.08); }

#cards-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 20px 24px;
}

#cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 14px;
}

/*  Challenge Card  */
.card {
  background: var(--bg1);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 18px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: var(--card-accent, var(--accent));
  opacity: 0;
  transition: opacity 0.2s;
}
.card:hover {
  border-color: var(--border2);
  background: var(--bg2);
  transform: translateY(-1px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
}
.card:hover::before { opacity: 1; }
.card-alert {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,77,109,0.45);
  background: rgba(255,77,109,0.18);
  color: #ffd6de;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.04em;
}

.card-cat {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.1em;
  margin-bottom: 8px;
  color: var(--card-accent);
}
.card-name {
  font-size: 15px;
  font-weight: 700;
  color: #fff;
  margin-bottom: 8px;
  line-height: 1.3;
}
.card-desc {
  font-size: 12px;
  color: var(--text-dim);
  line-height: 1.5;
  height: 36px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}
.card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: auto;
  padding-top: 14px;
  border-top: 1px solid var(--border);
}
.card-status {
  display: flex; align-items: center; gap: 6px;
  font-family: var(--font-mono);
  font-size: 11px;
}
.status-dot { width: 7px; height: 7px; border-radius: 50%; }
.status-unsolved .status-dot { background: var(--text-muted); }
.status-solving  .status-dot { background: var(--amber); animation: pulse 1.5s infinite; }
.status-solved   .status-dot { background: var(--cyan); }
.status-pending  .status-dot { background: var(--amber); animation: pulse 1.5s infinite; }
.status-running  .status-dot { background: var(--accent); animation: pulse 1.2s infinite; }
.status-waiting  .status-dot { background: var(--text-muted); }
.status-idle     .status-dot { background: var(--text-muted); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

.card-meta {
  display: flex; align-items: center; gap: 10px;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-muted);
}

/* empty state */
.empty-state {
  grid-column: 1/-1;
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}
.empty-state .empty-icon { font-size: 48px; margin-bottom: 16px; }
.empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text-dim); }
.empty-state p  { font-size: 13px; line-height: 1.6; }

/*  Modal  */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }

.modal {
  background: var(--bg1);
  border: 1px solid var(--border2);
  border-radius: var(--radius-lg);
  width: 560px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 24px 80px rgba(0,0,0,0.7);
  animation: modal-in 0.2s ease;
}
@keyframes modal-in { from { opacity:0; transform:scale(0.96) translateY(8px); } }

.modal-header {
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.modal-title { font-size: 16px; font-weight: 800; }
.modal-close {
  background: var(--bg3); border: 1px solid var(--border2);
  color: var(--text-dim); width: 28px; height: 28px;
  border-radius: 6px; cursor: pointer; font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.modal-close:hover { color: #fff; border-color: var(--text-dim); }

.modal-body { padding: 20px 24px; }
.modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

/*  Forms  */
.field { margin-bottom: 16px; }
.field label {
  display: block;
  font-size: 12px;
  font-weight: 700;
  color: var(--text-dim);
  letter-spacing: 0.06em;
  margin-bottom: 6px;
  font-family: var(--font-mono);
}
.field input, .field select, .field textarea {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 9px 12px;
  color: var(--text);
  font-family: var(--font-sans);
  font-size: 14px;
  transition: border-color 0.15s;
  outline: none;
}
.field input:focus, .field select:focus, .field textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(217,115,87,0.12);
}
.field textarea { min-height: 120px; resize: vertical; font-size: 13px; line-height: 1.6; }
.field select option { background: var(--bg2); }

.fields-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

/*  Build Modal  */
#build-log {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  height: 320px;
  overflow-y: auto;
  font-family: var(--font-mono);
  font-size: 11px;
  line-height: 1.7;
  color: var(--text-dim);
}
#build-log .log-line { word-break: break-all; }
#build-log .log-line.done  { color: var(--accent); font-weight: 700; }
#build-log .log-line.error { color: var(--red); font-weight: 700; }

/*  Challenge View  */
#view-challenge {
  flex-direction: row;
}

/* Sidebar */
#ch-sidebar {
  width: 280px;
  flex-shrink: 0;
  background: var(--bg1);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#ch-sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.back-btn {
  display: flex; align-items: center; gap: 6px;
  font-size: 12px; color: var(--text-dim);
  cursor: pointer; margin-bottom: 14px;
  transition: color 0.15s;
  background: none; border: none;
  font-family: var(--font-sans);
}
.back-btn:hover { color: var(--accent); }

.ch-name-block {}
.ch-category-badge {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.1em;
  margin-bottom: 5px;
}
.ch-title {
  font-size: 17px;
  font-weight: 800;
  color: #fff;
  line-height: 1.3;
}

#ch-sidebar-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.sidebar-section {
  margin-bottom: 20px;
}
.sidebar-section-title {
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.12em;
  color: var(--text-muted);
  margin-bottom: 10px;
  text-transform: uppercase;
}

/* Status badge */
.ch-status-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 5px 12px;
  border-radius: 99px;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  border: 1px solid;
}
.badge-unsolved { border-color: var(--border2); color: var(--text-dim); }
.badge-solving  { border-color: var(--amber); color: var(--amber); background: rgba(232,160,76,0.08); }
.badge-running  { border-color: var(--accent); color: var(--accent); background: rgba(217,115,87,0.08); }
.badge-waiting  { border-color: var(--text-muted); color: var(--text-muted); background: rgba(255,255,255,0.03); }
.badge-idle     { border-color: var(--text-muted); color: var(--text-muted); background: rgba(255,255,255,0.03); }
.badge-solved   { border-color: var(--cyan); color: var(--cyan); background: rgba(45,212,191,0.08); }
.badge-pending  { border-color: var(--amber); color: var(--amber); background: rgba(232,160,76,0.08); }

/* Description */
.ch-description {
  font-size: 12px;
  color: var(--text-dim);
  line-height: 1.7;
  white-space: pre-wrap;
  word-break: break-word;
}

/* File list */
.file-list { display: flex; flex-direction: column; gap: 5px; }
.file-item {
  display: flex; align-items: center; gap: 8px;
  padding: 7px 10px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
}
.file-item .file-icon { font-size: 13px; }
.file-empty { font-size: 12px; color: var(--text-muted); font-family: var(--font-mono); }

/* Upload zone */
#upload-zone {
  border: 1px dashed var(--border2);
  border-radius: var(--radius);
  padding: 18px 12px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}
#upload-zone:hover, #upload-zone.drag-over {
  border-color: var(--accent);
  background: rgba(217,115,87,0.05);
}
#upload-zone .upload-icon { font-size: 24px; margin-bottom: 6px; }
#upload-zone .upload-text { font-size: 11px; color: var(--text-dim); line-height: 1.5; }
#upload-zone .upload-hint { font-size: 10px; color: var(--text-muted); font-family: var(--font-mono); margin-top: 4px; }
#upload-input-hidden { display: none; }

#upload-progress {
  margin-top: 8px;
  display: none;
}
#upload-progress.visible { display: block; }
.upload-bar {
  height: 3px;
  background: var(--border);
  border-radius: 99px;
  overflow: hidden;
}
.upload-bar-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 99px;
  width: 0%;
  transition: width 0.3s;
  animation: upload-shimmer 1.5s infinite;
}
@keyframes upload-shimmer {
  0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; }
}

/* Cost */
.cost-display {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--amber);
  font-weight: 700;
}
.cost-tokens { font-size: 10px; color: var(--text-muted); margin-top: 3px; }

.writeup-panel { display: none; flex-direction: column; gap: 8px; }
.writeup-panel.visible { display: flex; }
#writeup-status { font-size: 11px; color: var(--text-dim); line-height: 1.4; }
.writeup-actions { display: flex; align-items: center; gap: 8px; }
.writeup-link {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--accent);
  text-decoration: none;
  border: 1px solid rgba(217,115,87,0.35);
  background: rgba(217,115,87,0.08);
  border-radius: 6px;
  padding: 6px 9px;
}
.writeup-link:hover { background: rgba(217,115,87,0.16); }

#writeup-content {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  max-height: 60vh;
  overflow: auto;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text);
  line-height: 1.6;
  white-space: pre-wrap;
}

#approval-candidate {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 8px 10px;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 12px;
}
#approval-notes {
  width: 100%;
  min-height: 90px;
  resize: vertical;
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 9px 10px;
  color: var(--text);
  font-family: var(--font-sans);
  font-size: 13px;
}

/* Sidebar actions */
#ch-sidebar-actions {
  padding: 14px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 7px;
  flex-shrink: 0;
}

/* Main area */
#ch-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/*  Chat feed  */
#chat-feed {
  flex: 1;
  overflow-y: auto;
  padding: 20px 28px 12px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.chat-msg { max-width: 720px; width: 100%; }
.chat-msg.reasoning {
  font-size: 14px;
  line-height: 1.75;
  color: var(--text);
  white-space: pre-wrap;
  word-break: break-word;
  padding: 2px 0;
}
.chat-msg.plan {
  font-size: 13px;
  line-height: 1.7;
  color: var(--text-dim);
  white-space: pre-wrap;
  word-break: break-word;
  padding: 10px 14px;
  background: rgba(217,115,87,0.05);
  border-left: 2px solid var(--accent);
  border-radius: 0 6px 6px 0;
  margin: 4px 0;
}
.chat-msg.replan { border-left-color: var(--amber); background: rgba(232,160,76,0.05); }
.chat-msg.system { font-size: 12px; color: var(--text-muted); font-style: italic; padding: 2px 0; }
.chat-msg.error  { font-size: 13px; color: var(--red); }

.chat-banner {
  max-width: 720px;
  border-radius: 6px;
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 1.6;
  margin: 2px 0;
  padding: 7px 12px;
  word-break: break-all;
}
.chat-banner.command { background: rgba(217,115,87,0.06); border: 1px solid rgba(217,115,87,0.18); color: var(--accent); }
.chat-banner.command::before { content: '$ '; opacity: 0.5; }
.chat-banner.gdb-command { background: rgba(167,139,250,0.06); border: 1px solid rgba(167,139,250,0.18); color: var(--purple); }
.chat-banner.gdb-command::before { content: ' '; }
.chat-banner.notice-command { background: rgba(232,160,76,0.06); border: 1px solid rgba(232,160,76,0.2); color: var(--amber); word-break: break-word; }
.chat-banner.notice-command::before { content: '! '; opacity: 0.75; }
.chat-banner.output {
  background: var(--bg2);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 13px;
  white-space: pre-wrap;
  word-break: break-word;
}

/*  Chat input bar  */
#chat-input-bar {
  flex-shrink: 0;
  padding: 10px 20px 14px;
  background: var(--bg1);
  border-top: 1px solid var(--border);
}
#agent-status-line {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  padding: 0 2px 5px;
}
#chat-input-wrap {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 10px 14px;
  transition: border-color 0.15s, box-shadow 0.15s;
}
#chat-input-wrap:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(217,115,87,0.1);
}
#prompt-input {
  display: block;
  width: 100%;
  background: transparent;
  border: none;
  outline: none;
  color: var(--text);
  font-family: var(--font-sans);
  font-size: 14px;
  line-height: 1.5;
  padding: 0;
  margin-bottom: 8px;
}
#prompt-input::placeholder { color: var(--text-muted); }
#chat-input-footer { display: flex; align-items: center; gap: 7px; }
#model-select {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 5px 9px;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 11px;
  outline: none;
  min-width: 150px;
}
.agent-activity {
  display: inline-flex; align-items: center; gap: 5px;
  font-family: var(--font-mono); font-size: 10px; letter-spacing: 0.08em;
}
.agent-activity .activity-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--text-muted);
  box-shadow: 0 0 0 0 rgba(217,115,87,0.0);
}
.agent-activity.running .activity-dot { background: var(--accent); animation: pulse 1.2s infinite; }
.agent-activity .activity-label { color: var(--text-muted); font-weight: 700; }
.agent-activity .activity-time  { color: var(--text-muted); letter-spacing: 0; font-weight: 400; }
#btn-launch {
  margin-left: auto;
  display: inline-flex; align-items: center; justify-content: center;
  width: 32px; height: 32px;
  border-radius: 8px;
  background: var(--accent);
  color: #fff; border: none; cursor: pointer;
  font-size: 16px; line-height: 1;
  transition: background 0.15s; flex-shrink: 0;
}
#btn-launch:hover:not(:disabled) { background: #e8845f; }
#btn-launch:disabled { opacity: 0.35; cursor: not-allowed; }

/* Flag banner */
#flag-banner {
  background: rgba(217,115,87,0.08);
  border-bottom: 1px solid rgba(217,115,87,0.35);
  padding: 10px 28px;
  display: none;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
  animation: flag-in 0.4s ease;
}
#flag-banner.visible { display: flex; }
@keyframes flag-in { from { opacity:0; transform:scale(0.98); } }
.flag-label { font-family: var(--font-mono); font-size: 11px; color: var(--accent); font-weight: 700; letter-spacing: 0.08em; }
.flag-value { font-family: var(--font-mono); font-size: 14px; color: #fff; font-weight: 600; flex: 1; word-break: break-all; }
.flag-copy  { background: rgba(217,115,87,0.15); border: 1px solid rgba(217,115,87,0.3); color: var(--accent); padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-family: var(--font-mono); transition: all 0.15s; }
.flag-copy:hover { background: rgba(217,115,87,0.25); }


/*  Manual solve  */
#manual-flag-input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 7px 10px;
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 12px;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
}
#manual-flag-input:focus {
  border-color: var(--cyan);
  box-shadow: 0 0 0 3px rgba(45,212,191,0.1);
}
#manual-flag-input::placeholder { color: var(--text-muted); }

/*  Settings modal key rows  */
.key-row {
  display: flex;
  flex-direction: column;
  gap: 7px;
}
.key-status {
  display: flex;
  align-items: center;
  gap: 7px;
  font-family: var(--font-mono);
  font-size: 11px;
  min-height: 18px;
}
.key-status .key-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 9px;
  border-radius: 99px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.06em;
}
.key-badge.set   { border: 1px solid rgba(45,212,191,0.4); color: var(--cyan); background: rgba(45,212,191,0.07); }
.key-badge.unset { border: 1px solid var(--border2); color: var(--text-muted); background: transparent; }
.key-badge .key-dot { width: 6px; height: 6px; border-radius: 50%; }
.key-badge.set   .key-dot { background: var(--cyan); }
.key-badge.unset .key-dot { background: var(--text-muted); }
.key-masked { color: var(--text-muted); font-size: 11px; font-family: var(--font-mono); }
.key-remove-btn {
  align-self: flex-start;
  background: rgba(224,92,107,0.1);
  border: 1px solid rgba(224,92,107,0.25);
  color: var(--red);
  font-size: 11px;
  font-family: var(--font-mono);
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.15s;
  display: none;
}
.key-remove-btn:hover { background: rgba(224,92,107,0.2); }
.key-remove-btn.visible { display: inline-flex; }
.security-row {
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.security-pill {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid var(--border2);
  background: transparent;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.05em;
  color: var(--text-muted);
}
.security-pill.on {
  border-color: rgba(45,212,191,0.45);
  color: var(--cyan);
  background: rgba(45,212,191,0.08);
}
.security-pill.off {
  border-color: var(--border2);
  color: var(--text-muted);
}
.security-action {
  border-radius: 999px;
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 5px 12px;
}

.containers-list {
  margin-top: 8px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  max-height: 220px;
  overflow: auto;
  background: var(--bg);
}
.containers-empty {
  padding: 10px;
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}
.container-row {
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 8px;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid var(--border);
}
.container-row:last-child { border-bottom: none; }
.container-meta { min-width: 0; }
.container-name {
  font-size: 12px;
  font-weight: 700;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.container-sub {
  margin-top: 2px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
}
.container-open {
  background: var(--bg3);
  color: var(--text);
  border: 1px solid var(--border2);
  border-radius: 6px;
  padding: 5px 8px;
  cursor: pointer;
  font-size: 11px;
}
.container-kill {
  background: rgba(224,92,107,0.12);
  color: var(--red);
  border: 1px solid rgba(224,92,107,0.28);
  border-radius: 6px;
  padding: 5px 8px;
  cursor: pointer;
  font-size: 11px;
}

/*  Run divider  */
.chat-run-divider {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0 6px;
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
  letter-spacing: 0.08em;
}
.chat-run-divider::before,
.chat-run-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/*  Toast  */
#toast-container {
  position: fixed;
  bottom: 20px; right: 20px;
  z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
  pointer-events: none;
}
.toast {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  padding: 10px 16px;
  font-size: 13px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5);
  animation: toast-in 0.2s ease;
  display: flex; align-items: center; gap: 10px;
  pointer-events: auto;
}
@keyframes toast-in { from { opacity:0; transform:translateY(10px); } }
.toast.success { border-color: rgba(217,115,87,0.4); }
.toast.error   { border-color: rgba(224,92,107,0.4); }

</style>
</head>
<body>
<div id="app">

  <!--  Topbar  -->
  <div id="topbar">
    <div id="topbar-logo">
      <span>&#128104;&#8205;&#129456;</span>
      <span class="brand-name">Big Stein (The Penetrator)</span>
      <span class="sep">|</span>
      <span id="topbar-title" style="font-weight:400;font-size:13px;color:var(--text-dim);">vibecoded by jack</span>
    </div>
    <div id="topbar-right">
      <div id="docker-menu-wrap">
        <button id="docker-status" class="status-pill" type="button" aria-haspopup="menu" aria-expanded="false">
          <div class="dot"></div>
          <span>checking docker...</span>
        </button>
        <div id="docker-menu">
          <div class="docker-menu-title">ACTIVE CONTAINERS</div>
          <div id="active-containers-list" class="containers-list">
            <div class="containers-empty">Loading...</div>
          </div>
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" id="btn-settings-open" title="API keys & settings">Settings</button>
      <button class="btn btn-ghost btn-sm" id="btn-lock-app" title="Lock workspace now" style="display:none">Lock</button>
      <button class="btn btn-ghost btn-sm" id="btn-build-open" title="Build Docker image">Build Image</button>
      <button class="btn btn-danger btn-sm" id="btn-reset-all" title="Delete all challenges and uploads">Reset All</button>
    </div>
  </div>

  <!--  Dashboard View  -->
  <div class="view active" id="view-dashboard">
    <div id="dash-header">
      <h1>Challenges</h1>
      <button id="dash-solved-toggle" class="dash-solved" type="button" title="Toggle solved display mode">Solved: 0/0</button>
      <div class="filter-tabs">
        <button class="filter-tab active" data-cat="all">ALL</button>
        <button class="filter-tab" data-cat="pwn">PWN</button>
        <button class="filter-tab" data-cat="web">WEB</button>
        <button class="filter-tab" data-cat="crypto">CRYPTO</button>
        <button class="filter-tab" data-cat="forensics">FORENSICS</button>
        <button class="filter-tab" data-cat="rev">REV</button>
        <button class="filter-tab" data-cat="misc">MISC</button>
        <button class="filter-tab" data-cat="osint">OSINT</button>
        <button class="filter-tab" data-cat="network">NETWORK</button>
      </div>
      <button id="btn-hide-solved" class="filter-toggle" type="button" aria-pressed="false">HIDE SOLVED</button>
      <div class="dash-cost" id="dash-cost">
        <span class="label">SESSION COST</span>
        <span class="value" id="dash-cost-value">$0.0000</span>
        <span class="tokens" id="dash-cost-tokens">0 in / 0 out</span>
      </div>
      <div>
        <button class="btn btn-primary" id="btn-new-challenge">+ New Challenge</button>
      </div>
    </div>
    <div id="cards-scroll">
      <div id="cards-grid"></div>
    </div>
  </div>

  <!--  Challenge View  -->
  <div class="view" id="view-challenge">
    <!-- Sidebar -->
    <div id="ch-sidebar">
      <div id="ch-sidebar-header">
        <button class="back-btn" id="btn-back">&lt;- Back to Challenges</button>
        <div class="ch-name-block">
          <div class="ch-category-badge" id="ch-category-badge">PWN</div>
          <div class="ch-title" id="ch-title">Challenge Name</div>
        </div>
      </div>

      <div id="ch-sidebar-body">
        <!-- Status -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">Status</div>
          <div id="ch-status-badge" class="ch-status-badge badge-unsolved">
            <span class="status-dot"></span> UNSOLVED
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Manual CLI</div>
          <button class="btn btn-sm btn-primary" id="btn-cli-start" style="width:100%;margin-bottom:7px;">Run Manually</button>
        </div>

        <!-- Description -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">Description</div>
          <div class="ch-description" id="ch-description">No description.</div>
        </div>

        <!-- Files -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">Files</div>
          <div class="file-list" id="file-list">
            <span class="file-empty">No files uploaded</span>
          </div>
        </div>

        <!-- Upload -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">Upload Files</div>
          <div id="upload-zone">
            <div class="upload-icon">&#128193;</div>
            <div class="upload-text">Drop files here or click to browse</div>
            <div class="upload-hint">Zips/tars are auto-extracted</div>
            <input type="file" id="upload-input-hidden" multiple>
          </div>
          <div id="upload-progress">
            <div class="upload-bar"><div class="upload-bar-fill" id="upload-bar-fill"></div></div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px;font-family:var(--font-mono)" id="upload-status-text">Uploading...</div>
          </div>
        </div>

        <!-- Cost -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">API Cost</div>
          <div class="cost-display" id="cost-display">-</div>
          <div class="cost-tokens" id="cost-tokens"></div>
        </div>

        <!-- Manual Solve -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">Mark as Solved</div>
          <div style="display:flex;flex-direction:column;gap:7px;">
            <input type="text" id="manual-flag-input" placeholder="flag{...}  (optional)">
            <button class="btn btn-sm" id="btn-mark-solved"
              style="width:100%;background:rgba(45,212,191,0.1);border:1px solid rgba(45,212,191,0.35);color:var(--cyan);">
              Mark Solved
            </button>
            <button class="btn btn-sm" id="btn-mark-unsolved"
              style="width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--border2);color:var(--text-muted);display:none;">
              Unmark Solved
            </button>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">Writeup</div>
          <div id="writeup-panel" class="writeup-panel">
            <div id="writeup-status">Writeup not generated yet.</div>
            <div class="writeup-actions">
              <button class="btn btn-sm btn-ghost" id="btn-open-writeup">Open Writeup</button>
              <a class="writeup-link" id="writeup-download" href="#" download>Download .md</a>
            </div>
          </div>
          <div id="writeup-empty" style="font-size:11px;color:var(--text-muted);font-family:var(--font-mono);">
            Approve a found flag to generate a markdown writeup.
          </div>
        </div>
      </div>

      <div id="ch-sidebar-actions">
        <button class="btn btn-danger btn-sm" id="btn-reset" style="width:100%">Reset Container</button>
        <button class="btn btn-danger btn-sm" id="btn-delete" style="width:100%;background:rgba(255,77,109,0.08)">Delete Challenge</button>
      </div>
    </div>

    <!-- Main -->
    <div id="ch-main">
      <!-- Flag banner -->
      <div id="flag-banner">
        <span style="font-size:20px">&#127881;</span>
        <div>
          <div class="flag-label">FLAG CAPTURED</div>
          <div class="flag-value" id="flag-value">flag{...}</div>
        </div>
        <button class="flag-copy" id="flag-copy">Copy</button>
      </div>

      <!-- Chat feed -->
      <div id="chat-feed"></div>

      <!-- Chat input bar -->
      <div id="chat-input-bar">
        <div id="agent-status-line">Idle.</div>
        <div id="chat-input-wrap">
          <input type="text" id="prompt-input" placeholder="Add context for the agent (Enter to launch)">
          <div id="chat-input-footer">
            <select id="model-select" title="Model (cheap to expensive)">
              {% for model in launch_models %}
              <option value="{{ model.id }}" {% if model.id == default_launch_model %}selected{% endif %}>{{ model.label }}</option>
              {% endfor %}
            </select>
            <span class="agent-activity" id="agent-activity">
              <span class="activity-dot"></span>
              <span class="activity-label" id="agent-activity-label">IDLE</span>
              <span class="activity-time" id="agent-activity-time"></span>
            </span>
            <button class="btn btn-danger btn-sm" id="btn-stop">Stop</button>
            <button class="btn btn-ghost btn-sm" id="btn-retry">Retry</button>
            <button class="btn btn-ghost btn-sm" id="btn-clear-feed" title="Clear chat feed">Clear</button>
            <button id="btn-launch" title="Launch agent">&#8593;</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--  New Challenge Modal  -->
<div class="modal-overlay" id="modal-new">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">New Challenge</div>
      <button class="modal-close" data-close="modal-new">X</button>
    </div>
    <div class="modal-body">
      <div class="fields-row">
        <div class="field">
          <label>CHALLENGE NAME</label>
          <input type="text" id="new-name" placeholder="e.g. Baby Stack, SQL Injection 101">
        </div>
        <div class="field">
          <label>CATEGORY</label>
          <select id="new-cat">
            <option value="pwn">PWN</option>
            <option value="web">WEB</option>
            <option value="crypto">CRYPTO</option>
            <option value="forensics">FORENSICS</option>
            <option value="rev">REV</option>
            <option value="misc">MISC</option>
            <option value="osint">OSINT</option>
            <option value="network">NETWORK</option>
          </select>
        </div>
      </div>
      <div class="field">
        <label>FLAG FORMAT <span style="color:var(--text-muted);font-weight:400">(optional - helps agent recognize the flag)</span></label>
        <input type="text" id="new-flagfmt" placeholder="e.g.  cyberfusion{...}   or   flag{...}">
      </div>
      <div class="field">
        <label>DESCRIPTION <span style="color:var(--text-muted);font-weight:400">(paste the full challenge text here)</span></label>
        <textarea id="new-desc" placeholder="Paste the complete challenge description, URLs, hints, anything the agent should know"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" data-close="modal-new">Cancel</button>
      <button class="btn btn-primary" id="btn-create-challenge">Create Challenge</button>
    </div>
  </div>
</div>

<!--  Settings Modal  -->
<div class="modal-overlay" id="modal-settings">
  <div class="modal" style="width:640px">
    <div class="modal-header">
      <div class="modal-title">Settings</div>
      <button class="modal-close" data-close="modal-settings">X</button>
    </div>
    <div class="modal-body">

      <!-- OpenAI key -->
      <div class="field">
        <label>OPENAI API KEY</label>
        <div class="key-row">
          <div class="key-status" id="oai-status"></div>
          <input type="password" id="oai-key-input" autocomplete="off"
                 placeholder="sk-proj-... (leave blank to keep current)">
          <button class="key-remove-btn" id="oai-remove" title="Remove key">Remove</button>
        </div>
      </div>

      <!-- Anthropic key -->
      <div class="field">
        <label>ANTHROPIC API KEY</label>
        <div class="key-row">
          <div class="key-status" id="ant-status"></div>
          <input type="password" id="ant-key-input" autocomplete="off"
                 placeholder="sk-ant-... (leave blank to keep current)">
          <button class="key-remove-btn" id="ant-remove" title="Remove key">Remove</button>
        </div>
      </div>

      <!-- Default model -->
      <div class="field">
        <label>DEFAULT MODEL <span style="color:var(--text-muted);font-weight:400">(used when launching agent)</span></label>
        <input type="text" id="settings-model" placeholder="e.g. gpt-5-mini">
      </div>
      <div class="field">
        <label>LOCAL LOCK</label>
        <div class="security-row">
          <span id="settings-lock-status-pill" class="security-pill off">SECURITY DISABLED</span>
          <button class="btn btn-ghost btn-sm security-action" id="btn-security-toggle" type="button">Enable Security</button>
          <button class="btn btn-ghost btn-sm security-action" id="btn-security-change" type="button" style="display:none">Change Password</button>
        </div>
      </div>

      <div id="settings-save-msg" style="font-size:12px;color:var(--cyan);display:none;margin-top:4px">
        Saved.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" data-close="modal-settings">Cancel</button>
      <button class="btn btn-primary" id="btn-save-settings">Save</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-security">
  <div class="modal" style="width:560px">
    <div class="modal-header">
      <div class="modal-title" id="security-modal-title">Security Setup</div>
      <button class="modal-close" data-close="modal-security">X</button>
    </div>
    <div class="modal-body">
      <p id="security-modal-subtitle" style="font-size:12px;color:var(--text-dim);line-height:1.5;margin-bottom:12px;">
        Configure local password protection for this workspace.
      </p>
      <div class="field" id="security-current-wrap">
        <label id="security-current-label">CURRENT PASSWORD</label>
        <input id="security-current" type="password" autocomplete="current-password">
      </div>
      <div class="field" id="security-new-wrap">
        <label id="security-new-label">NEW PASSWORD</label>
        <input id="security-new" type="password" autocomplete="new-password">
      </div>
      <div class="field" id="security-confirm-wrap" style="margin-bottom:0">
        <label>CONFIRM PASSWORD</label>
        <input id="security-confirm" type="password" autocomplete="new-password">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" data-close="modal-security">Cancel</button>
      <button class="btn btn-primary" id="btn-security-save">Save</button>
    </div>
  </div>
</div>

<!--  Build Image Modal  -->
<div class="modal-overlay" id="modal-build">
  <div class="modal" style="width:640px">
    <div class="modal-header">
      <div class="modal-title">Build Docker Image</div>
      <button class="modal-close" data-close="modal-build">X</button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:14px;line-height:1.6;">
        This builds a Kali Linux Docker image with all CTF tools pre-installed.
        Takes <strong style="color:var(--text)">5-15 minutes</strong> and requires ~4GB of disk space.
        Only needs to be done once.
      </p>
      <div id="build-log"><span style="color:var(--text-muted)">Press Build to start...</span></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" data-close="modal-build" id="btn-close-build">Close</button>
      <button class="btn btn-primary" id="btn-start-build">Build Image</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-flag-approval">
  <div class="modal" style="width:600px">
    <div class="modal-header">
      <div class="modal-title">Flag Found: Approval Required</div>
      <button class="modal-close" data-close="modal-flag-approval">X</button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-dim);line-height:1.6;margin-bottom:12px;">
        The agent produced a flag candidate. Test it on the challenge platform, then approve or reject it.
      </p>
      <div class="field">
        <label>CANDIDATE FLAG</label>
        <input id="approval-candidate" type="text">
      </div>
      <div class="field" style="margin-bottom:0;">
        <label>VALIDATION NOTES (optional)</label>
        <textarea id="approval-notes" placeholder="Example: Accepted by platform on first submit."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" id="btn-reject-candidate">Reject</button>
      <button class="btn btn-primary" id="btn-approve-candidate">Approve + Generate Writeup</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-writeup">
  <div class="modal" style="width:760px">
    <div class="modal-header">
      <div class="modal-title">Challenge Writeup</div>
      <button class="modal-close" data-close="modal-writeup">X</button>
    </div>
    <div class="modal-body">
      <pre id="writeup-content">No writeup generated yet.</pre>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" data-close="modal-writeup">Close</button>
      <a class="btn btn-primary" id="writeup-download-modal" href="#" download>Download .md</a>
    </div>
  </div>
</div>

<!--  Toast container  -->
<div id="toast-container"></div>

<script>
//  State 
const state = {
  challenges: [],
  currentCid: null,
  filter: 'all',
  hideSolved: false,
  solvedDisplayMode: 'fraction',
  agentRunning: false,
  lastActivityAt: null,
  lastActivityLabel: '',
  logCache: {},
  cardErrors: {},
  stepCount: 0,
  pendingCandidateFlag: '',
};

const STEP_LIMITS = {
  pwn: 120, rev: 100, web: 80, crypto: 80,
  forensics: 70, misc: 60, osint: 50, network: 60,
};

const CAT_COLORS = {
  pwn:'#e05c6b', web:'#2dd4bf', crypto:'#e8c44c', forensics:'#7ed56f',
  rev:'#f09cb4', misc:'#a78bfa', osint:'#f0c040', network:'#5b9cf6',
};

//  Socket.IO 
const socket = io();

socket.on('connect', () => {
  if (state.currentCid) socket.emit('join', { cid: state.currentCid });
  for (const c of state.challenges) {
    if (c.running) socket.emit('join', { cid: c.id });
  }
});

function cacheLog(cid, entry) {
  if (!cid) return;
  if (!state.logCache[cid]) state.logCache[cid] = [];
  state.logCache[cid].push(entry);
  if (state.logCache[cid].length > 2000) state.logCache[cid].splice(0, 200);
}

function handleLogEvent(ev, data) {
  const cid = data && data.cid;
  const t = Date.now() / 1000;
  if (cid) {
    const idx = state.challenges.findIndex(ch => ch.id === cid);
    if (idx >= 0 && !state.challenges[idx].running) {
      state.challenges[idx].running = true;
      renderCards();
    }
    if (cid === state.currentCid) {
      state.agentRunning = true;
      updateRunningUI();
    }
  }
  cacheLog(cid, { event: ev, data, ts: t });
  if (!cid || cid !== state.currentCid) return false;
  if (ev === 'plan') appendPlan(data.text || '', !!data.replan, t);
  else if (ev === 'thought') {
    const thoughtType = data.type || 'reasoning';
    if (thoughtType === 'reasoning') appendPlan(data.text || '', false, t);
    else appendAgent(data.text || '', thoughtType);
  } else if (ev === 'command') {
    const cmdType = data.gdb ? 'gdb-command' : (data.notice ? 'notice-command' : 'command');
    appendAgent(data.cmd || '', cmdType);
  }
  else if (ev === 'output') appendOutput(data.text || '', t);
  else if (ev === 'flag') {
    if (data.flag) showFlag(data.flag);
    appendAgent(`FLAG CANDIDATE FOUND: ${data.flag || ''}`, 'system');
    if (data.how) appendAgent(data.how, 'system');
  } else if (ev === 'done') {
    if (data.message) appendAgent(data.message, 'system');
  }
  return true;
}

function setCardError(cid, message) {
  if (!cid) return;
  state.cardErrors[cid] = String(message || 'Error');
}

function clearCardError(cid) {
  if (!cid || !state.cardErrors[cid]) return;
  delete state.cardErrors[cid];
}

socket.on('thought', (data) => {
  handleLogEvent('thought', data);
  if (data && data.cid === state.currentCid) markActivity('thinking');
});
socket.on('thought_stream_start', ({ id, type, cid }) => {
  if (!cid || cid === state.currentCid) {
    if ((type || 'reasoning') === 'reasoning') startPlanStream(id);
    else startAgentStream(id, type || 'reasoning');
  }
  if (cid === state.currentCid) {
    state.agentRunning = true;
    updateRunningUI();
    markActivity('thinking');
  }
});
socket.on('thought_stream_delta', ({ id, text, cid }) => {
  if (!cid || cid === state.currentCid) {
    if (!appendPlanStream(id, text || '')) appendAgentStream(id, text || '');
  }
  if (cid === state.currentCid) {
    state.agentRunning = true;
    markActivity('writing');
  }
});
socket.on('thought_stream_end', ({ id }) => {
  if (!endPlanStream(id)) endAgentStream(id);
});
socket.on('command', (data) => {
  handleLogEvent('command', data);
  if (data && data.cid === state.currentCid) {
    state.stepCount++;
    markActivity('running command');
  }
});
socket.on('output', (data) => {
  handleLogEvent('output', data);
  if (data && data.cid === state.currentCid) markActivity('container output');
});
socket.on('plan', (data) => {
  handleLogEvent('plan', data);
  if (data && data.cid === state.currentCid) markActivity('planning');
});
socket.on('flag', (data) => {
  handleLogEvent('flag', data);
  if (data && data.cid === state.currentCid) {
    markActivity('flag found');
    if (data.pending_approval) {
      const ch = state.challenges.find(c => c.id === data.cid);
      openApprovalModal(ch, data.flag || ch?.flag_candidate || '');
    }
  }
});
socket.on('done', (data) => {
  handleLogEvent('done', data);
  if (data && data.cid) {
    const idx = state.challenges.findIndex(ch => ch.id === data.cid);
    if (idx >= 0) {
      state.challenges[idx].running = false;
      if (data.status) state.challenges[idx].status = data.status;
    }
    renderCards();
  }
  if (!data || data.cid !== state.currentCid) return;
  state.agentRunning = false;
  updateRunningUI();
  refreshCurrentChallenge();
  if (data.status === 'pending_approval') {
    const ch = state.challenges.find(c => c.id === data.cid);
    openApprovalModal(ch, data.flag || ch?.flag_candidate || '');
  }
  markActivity('idle');
});
socket.on('flag_approved', (data) => {
  if (!data || !data.cid) return;
  if (data.cid === state.currentCid) {
    closeModal('modal-flag-approval');
    refreshCurrentChallenge();
  }
  toast('Flag approved. Writeup generated.', 'success');
});
socket.on('flag_rejected', (data) => {
  if (!data || !data.cid) return;
  if (data.cid === state.currentCid) {
    closeModal('modal-flag-approval');
    refreshCurrentChallenge();
  }
  toast('Flag candidate rejected.', 'info');
});
socket.on('error', (data) => {
  handleLogEvent('error', data);
  if (data && data.cid) {
    setCardError(data.cid, data.message || 'Error');
    renderCards();
  }
});
socket.on('cost', ({ cost, cost_usd, tokens_in, tokens_out, known, model, cid }) => {
  if (!cid || cid === state.currentCid) {
    const costEl = document.getElementById('cost-display');
    costEl.textContent = cost;
    if (known) {
      costEl.removeAttribute('title');
    } else {
      costEl.title = `Pricing not configured for ${model}. Set model_pricing in config.json.`;
    }
    document.getElementById('cost-tokens').textContent = `${tokens_in.toLocaleString()} in / ${tokens_out.toLocaleString()} out`;
  }

  if (cid) {
    const idx = state.challenges.findIndex(ch => ch.id === cid);
    if (idx >= 0) {
      if (typeof cost_usd === 'number') state.challenges[idx].cost_usd = cost_usd;
      state.challenges[idx].tokens_in = tokens_in || 0;
      state.challenges[idx].tokens_out = tokens_out || 0;
      updateDashboardMetrics();
      renderCards();
    }
  }
});
socket.on('file_uploaded', ({ name, listing }) => {
  toast(` Uploaded: ${name}`, 'success');
  refreshCurrentChallenge();
  appendOutput(`Uploaded: ${name}\n\n/ctf/ contents:\n${listing}`);
  hideUploadProgress();
});
socket.on('build_log', ({ line, done, error }) => {
  const log = document.getElementById('build-log');
  const el = document.createElement('div');
  el.className = 'log-line' + (done && !error ? ' done' : '') + (error ? ' error' : '');
  el.textContent = line;
  log.appendChild(el);
  log.scrollTop = log.scrollHeight;
  if (done) {
    document.getElementById('btn-start-build').disabled = false;
    document.getElementById('btn-start-build').textContent = ' Build Image';
    checkDockerStatus();
  }
});

//  API helpers 
async function api(path, opts = {}) {
  const r = await fetch(path, {
    cache: 'no-store',
    headers: { 'Content-Type': 'application/json' },
    ...opts,
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  });
  return r.json();
}

//  Docker status 
async function checkDockerStatus() {
  try {
    const s = await api(`/api/docker/status?t=${Date.now()}`);
    const el = document.getElementById('docker-status');
    if (!s.running) {
      el.className = 'status-pill warn';
      el.innerHTML = '<div class="dot"></div><span>Docker not running</span>';
    } else if (!s.image) {
      el.className = 'status-pill warn';
      el.innerHTML = '<div class="dot"></div><span>Image not built</span>';
    } else {
      el.className = 'status-pill ok';
      const n = (typeof s.active_containers === 'number') ? s.active_containers : (s.active_agents || 0);
      el.innerHTML = `<div class="dot"></div><span>Docker ready - ${n} containers running</span>`;
    }
  } catch {
    const el = document.getElementById('docker-status');
    el.className = 'status-pill warn';
    el.innerHTML = '<div class="dot"></div><span>Docker offline</span>';
  }
}
checkDockerStatus();
setInterval(checkDockerStatus, 15000);

//  Challenges 
async function loadChallenges() {
  state.challenges = await api('/api/challenges');
  renderCards();
  updateDashboardMetrics();
  // Join rooms for active challenges so logs keep streaming in background
  for (const c of state.challenges) {
    if (c.running) socket.emit('join', { cid: c.id });
  }
}

function renderCards() {
  const grid = document.getElementById('cards-grid');
  const categoryFiltered = state.filter === 'all'
    ? state.challenges
    : state.challenges.filter(c => c.category === state.filter);
  const filtered = state.hideSolved
    ? categoryFiltered.filter(c => c.status !== 'solved')
    : categoryFiltered;
  updateSolvedProgress();

  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">&#127988;</div>
        <h3>No challenges yet</h3>
        <p>Click <strong>+ New Challenge</strong> to add your first CTF challenge.</p>
      </div>`;
    return;
  }

  grid.innerHTML = filtered.map(c => {
    const color = CAT_COLORS[c.category] || '#888';
    const info = statusInfo(c);
    const statusClass = `status-${info.key}`;
    const statusText = info.label;
    const cardErr = state.cardErrors[c.id];
    const nFiles = (c.files || []).length;
    const cost = c.cost_usd > 0 ? `$${c.cost_usd.toFixed(3)}` : '-';
    const safeDesc = sanitizeText(c.description || 'No description');
    const desc = safeDesc.slice(0, 90) + (safeDesc.length > 90 ? '...' : '');

    return `
      <div class="card" onclick="openChallenge('${c.id}')" style="--card-accent:${color}">
        ${cardErr ? `<div class="card-alert" title="${escHtml(cardErr)}">ERROR</div>` : ''}
        <div class="card-cat" style="color:${color}">${c.category.toUpperCase()}</div>
        <div class="card-name">${escHtml(c.name)}</div>
        <div class="card-desc">${escHtml(desc)}</div>
        <div class="card-footer">
          <div class="card-status ${statusClass}">
            <div class="status-dot"></div>
            <span style="color:${info.color}">${statusText}</span>
          </div>
          <div class="card-meta">
            <span title="Files">Files: ${nFiles}</span>
            <span title="Cost">Cost: ${cost}</span>
          </div>
        </div>
      </div>`;
  }).join('');
}

function updateDashboardMetrics() {
  let totalCost = 0;
  let totalIn = 0;
  let totalOut = 0;
  for (const c of state.challenges) {
    totalCost += Number(c.cost_usd || 0);
    totalIn += Number(c.tokens_in || 0);
    totalOut += Number(c.tokens_out || 0);
  }
  const costEl = document.getElementById('dash-cost-value');
  const tokEl = document.getElementById('dash-cost-tokens');
  if (costEl) costEl.textContent = `$${totalCost.toFixed(4)}`;
  if (tokEl) tokEl.textContent = `${totalIn.toLocaleString()} in / ${totalOut.toLocaleString()} out`;
  updateSolvedProgress();
}

function updateSolvedProgress() {
  const solvedEl = document.getElementById('dash-solved-toggle');
  if (!solvedEl) return;
  const total = state.challenges.length;
  const solved = state.challenges.filter(c => c.status === 'solved').length;
  if (state.solvedDisplayMode === 'percent') {
    const pct = total === 0 ? 0 : Math.round((solved / total) * 100);
    solvedEl.textContent = `Solved: ${pct}%`;
  } else {
    solvedEl.textContent = `Solved: ${solved}/${total}`;
  }
}

//  Challenge view 
function openChallenge(cid) {
  const c = state.challenges.find(ch => ch.id === cid);
  if (!c) return;

  clearCardError(cid);
  renderCards();

  state.currentCid = cid;
  state.agentRunning = !!(c.running);  // preserve running state; don't flash IDLE
  state.stepCount = 0;

  // Join socket room
  socket.emit('join', { cid });

  // Clear logs
  document.getElementById('chat-feed').innerHTML = '';
  planStreams.clear();
  agentStreams.clear();
  document.getElementById('flag-banner').classList.remove('visible');
  document.getElementById('cost-display').textContent = '-';
  document.getElementById('cost-tokens').textContent = '';

  // Populate sidebar
  const color = CAT_COLORS[c.category] || '#888';
  const badge = document.getElementById('ch-category-badge');
  badge.textContent = c.category.toUpperCase();
  badge.style.color = color;
  document.getElementById('ch-title').textContent = sanitizeText(c.name);
  document.getElementById('ch-description').textContent = sanitizeText(c.description || 'No description provided.');

  renderFileList(c.files || []);
  renderStatusBadge(c.status, c.running);
  renderWriteupSection(c);

  if (c.flag) showFlag(c.flag);
  else if (c.flag_candidate) showFlag(c.flag_candidate);

  // Pre-fill manual flag input and set button state
  document.getElementById('manual-flag-input').value = c.flag || c.flag_candidate || '';
  updateSolveButtons(c.status);

  switchView('view-challenge');
  updateRunningUI();

  // Load persisted logs for this challenge
  api(`/api/challenges/${state.currentCid}/logs`).then(logs => {
    document.getElementById('chat-feed').innerHTML = '';
    planStreams.clear();
    agentStreams.clear();
    if (Array.isArray(logs)) {
      state.logCache[state.currentCid] = logs;
      for (const entry of logs) {
        const ev = entry.event;
        const data = entry.data || {};
        const t = entry.ts || null;
        if (ev === 'plan') {
          appendPlan(data.text || '', !!data.replan, t);
        } else if (ev === 'thought') {
          const thoughtType = data.type || 'reasoning';
          if (thoughtType === 'reasoning') appendPlan(data.text || '', false, t);
          else appendAgent(data.text || '', thoughtType);
        } else if (ev === 'command') {
          const cmdType = data.gdb ? 'gdb-command' : (data.notice ? 'notice-command' : 'command');
          appendAgent(data.cmd || '', cmdType);
        } else if (ev === 'output') {
          appendOutput(data.text || '', t);
        } else if (ev === 'flag') {
          if (data.flag) showFlag(data.flag);
          appendAgent(`FLAG CANDIDATE FOUND: ${data.flag || ''}`, 'system');
          if (data.how) appendAgent(data.how, 'system');
        } else if (ev === 'done') {
          if (data.message) appendAgent(data.message, 'system');
        }
      }
    }
  });
  if (c.status === 'pending_approval' && c.flag_candidate) {
    openApprovalModal(c, c.flag_candidate);
  }
}

function renderFileList(files) {
  const list = document.getElementById('file-list');
  if (!files.length) {
    list.innerHTML = '<span class="file-empty">No files uploaded</span>';
    return;
  }
  list.innerHTML = files.map(f => `
    <div class="file-item">
      <span class="file-icon">&#128196;</span>
      <span style="word-break:break-all;min-width:0">${escHtml(f)}</span>
    </div>`).join('');
}

function statusInfo(c) {
  if (c.running) return { key: 'running', label: 'RUNNING', color: 'var(--accent)' };
  if (c.status === 'pending_approval') return { key: 'pending', label: 'PENDING APPROVAL', color: 'var(--amber)' };
  if (c.status === 'solving') return { key: 'solving', label: 'SOLVING', color: 'var(--amber)' };
  if (c.status === 'solved') return { key: 'solved', label: 'SOLVED', color: 'var(--cyan)' };
  if (c.status === 'unsolved') return { key: 'unsolved', label: 'UNSOLVED', color: 'var(--text-muted)' };
  return { key: 'idle', label: 'IDLE', color: 'var(--text-muted)' };
}

function renderStatusBadge(status, running = false) {
  const el = document.getElementById('ch-status-badge');
  const info = statusInfo({ status, running });
  el.className = `ch-status-badge badge-${info.key}`;
  el.innerHTML = `<span class="status-dot"></span> ${info.label}`;
}

async function refreshCurrentChallenge() {
  if (!state.currentCid) return;
  const c = await api(`/api/challenges/${state.currentCid}`);
  // Update in state
  const idx = state.challenges.findIndex(ch => ch.id === state.currentCid);
  if (idx >= 0) state.challenges[idx] = c;
  renderFileList(c.files || []);
  renderStatusBadge(c.status, c.running);
  renderWriteupSection(c);
  state.agentRunning = !!c.running;
  updateRunningUI();
  updateSolveButtons(c.status);
  if (c.flag || c.flag_candidate) document.getElementById('manual-flag-input').value = c.flag || c.flag_candidate;
  if (c.flag) showFlag(c.flag);
  else if (c.flag_candidate) showFlag(c.flag_candidate);
}

//  Logs 
function formatTs(t) {
  if (!t) return ts();
  const d = new Date(t * 1000);
  const hh = String(d.getHours()).padStart(2, '0');
  const mm = String(d.getMinutes()).padStart(2, '0');
  const ss = String(d.getSeconds()).padStart(2, '0');
  return `${hh}:${mm}:${ss}`;
}

function appendPlan(text, replan = false, t = null) {
  const feed = document.getElementById('chat-feed');
  const el = document.createElement('div');
  el.className = `chat-msg plan${replan ? ' replan' : ''}`;
  el.textContent = sanitizeText(text);
  feed.appendChild(el);
  feed.scrollTop = feed.scrollHeight;
}

function appendAgent(text, type = 'reasoning') {
  const feed = document.getElementById('chat-feed');
  const el = document.createElement('div');
  if (type === 'command' || type === 'gdb-command' || type === 'notice-command') {
    el.className = `chat-banner ${type}`;
  } else if (type === 'system' || type === 'error') {
    el.className = `chat-msg ${type}`;
  } else {
    el.className = 'chat-msg reasoning';
  }
  el.textContent = sanitizeText(text);
  feed.appendChild(el);
  feed.scrollTop = feed.scrollHeight;
}

const agentStreams = new Map();
const planStreams = new Map();
function startPlanStream(id) {
  const feed = document.getElementById('chat-feed');
  const el = document.createElement('div');
  el.className = 'chat-msg plan';
  el.dataset.streamId = id;
  el.textContent = '';
  feed.appendChild(el);
  planStreams.set(id, el);
  feed.scrollTop = feed.scrollHeight;
}
function appendPlanStream(id, text) {
  const el = planStreams.get(id);
  if (!el) return false;
  el.textContent += sanitizeText(text);
  const feed = document.getElementById('chat-feed');
  feed.scrollTop = feed.scrollHeight;
  return true;
}
function endPlanStream(id) {
  if (!planStreams.has(id)) return false;
  planStreams.delete(id);
  return true;
}
function startAgentStream(id, type = 'reasoning') {
  const feed = document.getElementById('chat-feed');
  const el = document.createElement('div');
  if (type === 'command' || type === 'gdb-command' || type === 'notice-command') {
    el.className = `chat-banner ${type}`;
  } else {
    el.className = 'chat-msg reasoning';
  }
  el.dataset.streamId = id;
  el.textContent = '';
  feed.appendChild(el);
  agentStreams.set(id, el);
  feed.scrollTop = feed.scrollHeight;
}
function appendAgentStream(id, text) {
  const el = agentStreams.get(id);
  if (!el) return false;
  el.textContent += sanitizeText(text);
  const feed = document.getElementById('chat-feed');
  feed.scrollTop = feed.scrollHeight;
  return true;
}
function endAgentStream(id) {
  if (!agentStreams.has(id)) return false;
  agentStreams.delete(id);
  return true;
}

function appendOutput(text, t = null) {
  const feed = document.getElementById('chat-feed');
  const el = document.createElement('div');
  el.className = 'chat-banner output';
  el.textContent = sanitizeText(text);
  feed.appendChild(el);
  feed.scrollTop = feed.scrollHeight;
}

function updateSolveButtons(status) {
  const solveBtn   = document.getElementById('btn-mark-solved');
  const unsolveBtn = document.getElementById('btn-mark-unsolved');
  if (!solveBtn || !unsolveBtn) return;
  if (status === 'solved') {
    solveBtn.style.display   = 'none';
    unsolveBtn.style.display = '';
  } else {
    solveBtn.style.display   = '';
    unsolveBtn.style.display = 'none';
  }
}

function appendRunDivider(label = 'Retry') {
  const feed = document.getElementById('chat-feed');
  const el = document.createElement('div');
  el.className = 'chat-run-divider';
  el.textContent = `${label} - ${ts()}`;
  feed.appendChild(el);
  feed.scrollTop = feed.scrollHeight;
}

function markActivity(label) {
  state.lastActivityAt = Date.now();
  state.lastActivityLabel = label || state.lastActivityLabel || 'active';
  updateAgentActivity();
}

function formatAgo(ms) {
  if (ms < 1000) return 'just now';
  const s = Math.floor(ms / 1000);
  if (s < 60) return `${s}s ago`;
  const m = Math.floor(s / 60);
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  return `${h}h ago`;
}

function updateAgentActivity() {
  const el = document.getElementById('agent-activity');
  const labelEl = document.getElementById('agent-activity-label');
  const timeEl = document.getElementById('agent-activity-time');
  const statusLine = document.getElementById('agent-status-line');
  if (!el || !labelEl || !timeEl) return;

  if (!state.agentRunning) {
    el.classList.remove('running');
    labelEl.textContent = 'IDLE';
    timeEl.textContent = '';
    if (statusLine) statusLine.textContent = 'Idle.';
    return;
  }

  el.classList.add('running');
  const baseLabel = state.lastActivityLabel || 'RUNNING';
  labelEl.textContent = baseLabel.toUpperCase();
  let agoText = '...';
  let ageMs = null;
  if (state.lastActivityAt) {
    ageMs = Date.now() - state.lastActivityAt;
    agoText = formatAgo(ageMs);
  }
  timeEl.textContent = agoText;

  if (statusLine) {
    const ch = state.challenges.find(c => c.id === state.currentCid);
    const limit = ch ? (STEP_LIMITS[ch.category] || 80) : null;
    const stepStr = limit ? `step ${state.stepCount}/${limit}` : `step ${state.stepCount}`;
    if (ageMs !== null && ageMs > 5000) {
      statusLine.textContent = `Waiting on model response (${stepStr}, no output for ${agoText})`;
    } else if (state.lastActivityLabel) {
      statusLine.textContent = `Running: ${state.lastActivityLabel} - ${stepStr}`;
    } else {
      statusLine.textContent = `Running - ${stepStr}`;
    }
  }
}

let activityTimer = null;
function startActivityTimer() {
  if (activityTimer) return;
  activityTimer = setInterval(updateAgentActivity, 1000);
}
function stopActivityTimer() {
  if (activityTimer) clearInterval(activityTimer);
  activityTimer = null;
}

function showFlag(flag) {
  const banner = document.getElementById('flag-banner');
  document.getElementById('flag-value').textContent = sanitizeText(flag);
  banner.classList.add('visible');
}

function renderWriteupSection(challenge) {
  const panel = document.getElementById('writeup-panel');
  const empty = document.getElementById('writeup-empty');
  const status = document.getElementById('writeup-status');
  const dl = document.getElementById('writeup-download');
  const dlModal = document.getElementById('writeup-download-modal');
  if (!panel || !empty || !status || !dl || !dlModal) return;
  if (!challenge || !challenge.id) {
    panel.classList.remove('visible');
    empty.style.display = '';
    return;
  }
  const hasWriteup = !!(challenge.writeup_md && String(challenge.writeup_md).trim());
  const href = `/api/challenges/${challenge.id}/writeup.md`;
  dl.href = href;
  dlModal.href = href;
  if (hasWriteup) {
    panel.classList.add('visible');
    empty.style.display = 'none';
    status.textContent = `Writeup ready${challenge.writeup_ready_at ? ` (${challenge.writeup_ready_at})` : ''}.`;
  } else {
    panel.classList.remove('visible');
    empty.style.display = '';
  }
}

function openApprovalModal(challenge, candidateFlag = '') {
  if (!challenge || !challenge.id) return;
  const candidate = (candidateFlag || challenge.flag_candidate || challenge.flag || '').trim();
  if (!candidate) return;
  state.pendingCandidateFlag = candidate;
  document.getElementById('approval-candidate').value = candidate;
  if (!document.getElementById('approval-notes').value.trim()) {
    document.getElementById('approval-notes').value = '';
  }
  openModal('modal-flag-approval');
}

async function openWriteupModal() {
  if (!state.currentCid) return;
  const res = await api(`/api/challenges/${state.currentCid}/writeup`);
  if (!res || res.error || !res.ready) {
    toast('Writeup not generated yet.', 'info');
    return;
  }
  document.getElementById('writeup-content').textContent = res.markdown || '';
  openModal('modal-writeup');
}

//  Upload 
function setupUpload() {
  const zone  = document.getElementById('upload-zone');
  const input = document.getElementById('upload-input-hidden');

  zone.addEventListener('click', () => input.click());
  input.addEventListener('change', () => uploadFiles(input.files));

  zone.addEventListener('dragover', e => {
    e.preventDefault();
    zone.classList.add('drag-over');
  });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    uploadFiles(e.dataTransfer.files);
  });
}

function showUploadProgress(name) {
  document.getElementById('upload-progress').classList.add('visible');
  document.getElementById('upload-status-text').textContent = `Uploading ${name}...`;
  document.getElementById('upload-bar-fill').style.width = '60%';
}
function hideUploadProgress() {
  document.getElementById('upload-bar-fill').style.width = '100%';
  setTimeout(() => {
    document.getElementById('upload-progress').classList.remove('visible');
    document.getElementById('upload-bar-fill').style.width = '0%';
  }, 800);
}

async function uploadFiles(files) {
  if (!state.currentCid || !files.length) return;
  for (const file of files) {
    showUploadProgress(file.name);
    const fd = new FormData();
    fd.append('file', file);
    try {
      const r = await fetch(`/api/challenges/${state.currentCid}/upload`, {
        method: 'POST', body: fd,
      });
      const data = await r.json();
      if (data.error) {
        toast(`Upload failed: ${data.error}`, 'error');
        hideUploadProgress();
      } else {
        hideUploadProgress();
        refreshCurrentChallenge(); // ensure UI updates even if socket events drop
      }
    } catch (e) {
      toast(`Upload error: ${e}`, 'error');
      hideUploadProgress();
    }
  }
  document.getElementById('upload-input-hidden').value = '';
}

//  Agent 
function updateRunningUI() {
  document.getElementById('btn-launch').disabled  = state.agentRunning;
  document.getElementById('btn-retry').disabled   = state.agentRunning;
  document.getElementById('btn-stop').disabled    = !state.agentRunning;
  document.getElementById('model-select').disabled = state.agentRunning;
  updateAgentActivity();
  if (state.agentRunning) startActivityTimer();
  else stopActivityTimer();
}

async function launch(retry = false) {
  if (!state.currentCid) return;
  const extra = document.getElementById('prompt-input').value.trim();
  const model = document.getElementById('model-select').value;
  document.getElementById('prompt-input').value = '';

  state.agentRunning = true;
  markActivity('starting');
  updateRunningUI();

  // Clear logs on fresh launch; separator on retry
  if (!retry) {
    document.getElementById('chat-feed').innerHTML = '';
    planStreams.clear();
    agentStreams.clear();
    document.getElementById('flag-banner').classList.remove('visible');
    document.getElementById('cost-display').textContent = '-';
    document.getElementById('cost-tokens').textContent = '';
    state.stepCount = 0;
  } else {
    appendRunDivider('Retry');
    state.stepCount = 0;
  }

  const res = await api(`/api/challenges/${state.currentCid}/launch`, {
    method: 'POST',
    body: { retry, extra_context: extra, model },
  });

  if (res.error) {
    toast(`Launch failed: ${res.error}`, 'error');
    state.agentRunning = false;
    updateRunningUI();
  } else {
    const idx = state.challenges.findIndex(ch => ch.id === state.currentCid);
    if (idx >= 0) {
      state.challenges[idx].status = 'solving';
      state.challenges[idx].running = true;
    }
    renderStatusBadge('solving', true);
    updateDashboardMetrics();
    renderCards();
    checkDockerStatus();
  }
}

//  Event Listeners 
document.addEventListener('DOMContentLoaded', () => {
  setupUpload();
  loadChallenges();
  refreshLockUI();

  // Back button
  document.getElementById('btn-back').addEventListener('click', () => {
    state.currentCid = null;
    switchView('view-dashboard');
    loadChallenges();
  });

  // Filter tabs
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      state.filter = tab.dataset.cat;
      renderCards();
    });
  });
  const hideSolvedBtn = document.getElementById('btn-hide-solved');
  hideSolvedBtn.addEventListener('click', () => {
    state.hideSolved = !state.hideSolved;
    hideSolvedBtn.classList.toggle('active', state.hideSolved);
    hideSolvedBtn.setAttribute('aria-pressed', state.hideSolved ? 'true' : 'false');
    hideSolvedBtn.textContent = state.hideSolved ? 'SHOW SOLVED' : 'HIDE SOLVED';
    renderCards();
  });
  const solvedToggle = document.getElementById('dash-solved-toggle');
  solvedToggle.addEventListener('click', () => {
    state.solvedDisplayMode = state.solvedDisplayMode === 'fraction' ? 'percent' : 'fraction';
    updateSolvedProgress();
  });

  // New challenge
  document.getElementById('btn-new-challenge').addEventListener('click', () => openModal('modal-new'));
  document.getElementById('btn-create-challenge').addEventListener('click', async () => {
    const name = document.getElementById('new-name').value.trim();
    if (!name) { document.getElementById('new-name').focus(); return; }
    const newChal = await api('/api/challenges', {
      method: 'POST',
      body: {
        name,
        category: document.getElementById('new-cat').value,
        flag_format: document.getElementById('new-flagfmt').value.trim(),
        description: document.getElementById('new-desc').value.trim(),
      }
    });
    document.getElementById('new-name').value = '';
    document.getElementById('new-flagfmt').value = '';
    document.getElementById('new-desc').value = '';
    closeModal('modal-new');
    // Add to local state and open immediately so the upload zone is visible
    state.challenges.push(newChal);
    openChallenge(newChal.id);
  });

  // Enter to create challenge
  document.getElementById('new-name').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('btn-create-challenge').click();
  });

  // Agent controls
  document.getElementById('btn-launch').addEventListener('click', () => launch(false));
  document.getElementById('btn-retry').addEventListener('click', () => launch(true));
  document.getElementById('btn-cli-start').addEventListener('click', async () => {
    if (!state.currentCid) return;
    const res = await api(`/api/challenges/${state.currentCid}/manual-start`, {
      method: 'POST',
      body: { open_terminal: true },
    });
    if (!res || res.error) {
      toast(res?.error || 'Failed to initialize manual container.', 'error');
      return;
    }
    if (res.terminal_opened) {
      toast('Manual terminal opened. Agent was not started.', 'success');
    } else if (res.terminal_error) {
      toast(`Container started, but terminal popup failed: ${res.terminal_error}`, 'error');
    } else {
      toast('Container started for manual mode.', 'success');
    }
    checkDockerStatus();
  });
  document.getElementById('btn-clear-feed').addEventListener('click', () => {
    document.getElementById('chat-feed').innerHTML = '';
    planStreams.clear();
    agentStreams.clear();
  });
  document.getElementById('btn-stop').addEventListener('click', async () => {
    let res = null;
    try {
      res = await api(`/api/challenges/${state.currentCid}/stop`, { method: 'POST' });
    } catch (e) {
      toast(`Stop failed: ${e}`, 'error');
      return;
    }
    if (res && res.error) {
      toast(`Stop failed: ${res.error}`, 'error');
      return;
    }
    state.agentRunning = false;
    updateRunningUI();
    const idx = state.challenges.findIndex(ch => ch.id === state.currentCid);
    if (idx >= 0) state.challenges[idx].running = false;
    renderStatusBadge('unsolved', false);
    updateDashboardMetrics();
    renderCards();
    appendAgent('Agent stopped.', 'system');
    checkDockerStatus();
  });

  // Enter to launch
  document.getElementById('prompt-input').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !state.agentRunning) launch(false);
  });

  // Manual solve / unsolve
  document.getElementById('btn-mark-solved').addEventListener('click', async () => {
    if (!state.currentCid) return;
    const flagVal = document.getElementById('manual-flag-input').value.trim();
    const body = {
      status: 'solved',
      flag_candidate: flagVal || null,
      approved_at: new Date().toISOString(),
    };
    if (flagVal) body.flag = flagVal;
    const res = await api(`/api/challenges/${state.currentCid}`, { method: 'PUT', body });
    if (res && res.id) {
      const idx = state.challenges.findIndex(ch => ch.id === state.currentCid);
      if (idx >= 0) {
        state.challenges[idx].status = 'solved';
        if (flagVal) {
          state.challenges[idx].flag = flagVal;
          state.challenges[idx].flag_candidate = flagVal;
        }
      }
      renderStatusBadge('solved', false);
      renderWriteupSection(res);
      renderCards();
      updateSolveButtons('solved');
      if (flagVal) showFlag(flagVal);
      else { document.getElementById('flag-banner').classList.remove('visible'); }
      toast('Challenge marked as solved!', 'success');
    } else {
      toast('Failed to update challenge', 'error');
    }
  });

  document.getElementById('btn-mark-unsolved').addEventListener('click', async () => {
    if (!state.currentCid) return;
    const res = await api(`/api/challenges/${state.currentCid}`, {
      method: 'PUT',
      body: {
        status: 'unsolved',
        flag: null,
        flag_candidate: null,
        flag_how: null,
        approved_at: null,
        writeup_md: null,
        writeup_path: null,
        writeup_ready_at: null,
      },
    });
    if (res && res.id) {
      const idx = state.challenges.findIndex(ch => ch.id === state.currentCid);
      if (idx >= 0) {
        state.challenges[idx].status = 'unsolved';
        state.challenges[idx].flag = null;
        state.challenges[idx].flag_candidate = null;
        state.challenges[idx].writeup_md = null;
      }
      renderStatusBadge('unsolved', false);
      renderWriteupSection(res);
      renderCards();
      updateSolveButtons('unsolved');
      document.getElementById('flag-banner').classList.remove('visible');
      document.getElementById('manual-flag-input').value = '';
      toast('Challenge unmarked.', 'success');
    } else {
      toast('Failed to update challenge', 'error');
    }
  });

  document.getElementById('btn-open-writeup').addEventListener('click', async () => {
    await openWriteupModal();
  });

  document.getElementById('btn-approve-candidate').addEventListener('click', async () => {
    if (!state.currentCid) return;
    const candidate = document.getElementById('approval-candidate').value.trim();
    if (!candidate) {
      toast('Candidate flag is empty.', 'error');
      return;
    }
    const notes = document.getElementById('approval-notes').value.trim();
    const res = await api(`/api/challenges/${state.currentCid}/approve-flag`, {
      method: 'POST',
      body: { approved: true, flag: candidate, notes },
    });
    if (res && res.id) {
      const idx = state.challenges.findIndex(ch => ch.id === state.currentCid);
      if (idx >= 0) state.challenges[idx] = res;
      renderStatusBadge(res.status, !!res.running);
      renderWriteupSection(res);
      renderCards();
      updateSolveButtons(res.status);
      if (res.flag) showFlag(res.flag);
      closeModal('modal-flag-approval');
      toast('Flag approved and writeup generated.', 'success');
    } else {
      toast(res?.error || 'Failed to approve flag candidate.', 'error');
    }
  });

  document.getElementById('btn-reject-candidate').addEventListener('click', async () => {
    if (!state.currentCid) return;
    const candidate = document.getElementById('approval-candidate').value.trim();
    const notes = document.getElementById('approval-notes').value.trim();
    const res = await api(`/api/challenges/${state.currentCid}/approve-flag`, {
      method: 'POST',
      body: { approved: false, flag: candidate, notes },
    });
    if (res && res.id) {
      const idx = state.challenges.findIndex(ch => ch.id === state.currentCid);
      if (idx >= 0) state.challenges[idx] = res;
      renderStatusBadge(res.status, !!res.running);
      renderWriteupSection(res);
      renderCards();
      updateSolveButtons(res.status);
      document.getElementById('flag-banner').classList.remove('visible');
      closeModal('modal-flag-approval');
      toast('Flag candidate rejected.', 'info');
    } else {
      toast(res?.error || 'Failed to reject flag candidate.', 'error');
    }
  });

  // Reset & Delete
  document.getElementById('btn-reset').addEventListener('click', async () => {
    if (!confirm('Reset container? This kills the Docker container and agent state but keeps challenge files.')) return;
    await api(`/api/challenges/${state.currentCid}/reset`, { method: 'POST' });
    state.agentRunning = false;
    updateRunningUI();
    document.getElementById('chat-feed').innerHTML = '';
    planStreams.clear();
    agentStreams.clear();
    document.getElementById('flag-banner').classList.remove('visible');
    renderStatusBadge('unsolved');
    await refreshCurrentChallenge();
    checkDockerStatus();
    toast('Container reset. Files preserved.', 'success');
  });

  document.getElementById('btn-delete').addEventListener('click', async () => {
    const c = state.challenges.find(ch => ch.id === state.currentCid);
    if (!confirm(`Delete "${c?.name}"? This cannot be undone.`)) return;
    await api(`/api/challenges/${state.currentCid}`, { method: 'DELETE' });
    state.currentCid = null;
    switchView('view-dashboard');
    loadChallenges();
    checkDockerStatus();
    toast('Challenge deleted.', 'success');
  });

  // Flag copy
  document.getElementById('flag-copy').addEventListener('click', () => {
    navigator.clipboard.writeText(document.getElementById('flag-value').textContent);
    document.getElementById('flag-copy').textContent = 'Copied!';
    setTimeout(() => { document.getElementById('flag-copy').textContent = 'Copy'; }, 2000);
  });

  // Settings
  document.getElementById('btn-settings-open').addEventListener('click', () => {
    setDockerMenuOpen(false);
    loadSettings();
    openModal('modal-settings');
  });
  document.getElementById('btn-lock-app').addEventListener('click', async () => {
    const res = await api('/api/auth/lock', { method: 'POST' });
    if (!res || res.error) {
      toast(res?.error || 'Failed to lock workspace.', 'error');
      return;
    }
    window.location.reload();
  });
  document.getElementById('docker-status').addEventListener('click', async (e) => {
    e.stopPropagation();
    await toggleDockerMenu();
  });
  document.getElementById('docker-menu').addEventListener('click', (e) => {
    e.stopPropagation();
  });
  document.addEventListener('click', () => setDockerMenuOpen(false));
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') setDockerMenuOpen(false);
  });
  document.getElementById('oai-remove').addEventListener('click', () => {
    _settingsClearOai = true;
    const oaiStatus = document.getElementById('oai-status');
    oaiStatus.innerHTML = `<span class="key-badge unset"><span class="key-dot"></span>WILL BE REMOVED</span>`;
    document.getElementById('oai-remove').classList.remove('visible');
    document.getElementById('oai-key-input').value = '';
  });
  document.getElementById('ant-remove').addEventListener('click', () => {
    _settingsClearAnt = true;
    const antStatus = document.getElementById('ant-status');
    antStatus.innerHTML = `<span class="key-badge unset"><span class="key-dot"></span>WILL BE REMOVED</span>`;
    document.getElementById('ant-remove').classList.remove('visible');
    document.getElementById('ant-key-input').value = '';
  });
  document.getElementById('btn-save-settings').addEventListener('click', async () => {
    const body = {
      openai_api_key:    document.getElementById('oai-key-input').value.trim(),
      anthropic_api_key: document.getElementById('ant-key-input').value.trim(),
      model:             document.getElementById('settings-model').value.trim(),
      clear_openai:      _settingsClearOai,
      clear_anthropic:   _settingsClearAnt,
    };
    const res = await api('/api/config', { method: 'POST', body });
    if (res.ok) {
      document.getElementById('settings-save-msg').style.display = 'block';
      await loadSettings();  // refresh status badges
      await refreshLockUI();
      closeModal('modal-settings');
    } else {
      toast(res?.error || 'Save failed', 'error');
    }
  });
  document.getElementById('btn-security-toggle').addEventListener('click', async () => {
    if (!_securityEnabled) {
      if (_securityPasswordSet) {
        const res = await api('/api/config', { method: 'POST', body: { local_lock_enabled: true } });
        if (!res || res.error) {
          toast(res?.error || 'Failed to enable security.', 'error');
          return;
        }
        toast('Security enabled.', 'success');
        await loadSettings();
        await refreshLockUI();
        return;
      }
      openSecurityModal('enable');
      return;
    }
    openSecurityModal('disable');
  });
  document.getElementById('btn-security-change').addEventListener('click', () => openSecurityModal('change'));
  document.getElementById('btn-security-save').addEventListener('click', async () => {
    await submitSecurityAction();
  });
  document.getElementById('active-containers-list').addEventListener('click', async (e) => {
    const openBtn = e.target.closest('[data-open-cid]');
    if (openBtn) {
      const cid = openBtn.getAttribute('data-open-cid');
      const isManual = openBtn.getAttribute('data-open-manual') === '1';
      if (cid) await openChallengeFromContainerList(cid, isManual);
      return;
    }
    const killBtn = e.target.closest('[data-kill-cid]');
    if (killBtn) {
      const cid = killBtn.getAttribute('data-kill-cid');
      if (cid) await killContainerFromContainerList(cid);
    }
  });

  // Build image
  document.getElementById('btn-build-open').addEventListener('click', () => openModal('modal-build'));
  document.getElementById('btn-start-build').addEventListener('click', async () => {
    document.getElementById('build-log').innerHTML = '';
    document.getElementById('btn-start-build').disabled = true;
    document.getElementById('btn-start-build').textContent = 'Building...';
    await api('/api/docker/build', { method: 'POST' });
  });

  // Global reset
  document.getElementById('btn-reset-all').addEventListener('click', async () => {
    if (!confirm('Reset ALL challenges and uploads? This permanently deletes every challenge, upload, and log.')) return;
    let res = null;
    try {
      res = await api('/api/reset-all', { method: 'POST' });
    } catch (e) {
      toast(`Reset failed: ${e}`, 'error');
      return;
    }
    if (res && res.error) {
      toast(`Reset failed: ${res.error}`, 'error');
      return;
    }
    state.currentCid = null;
    state.challenges = [];
    state.agentRunning = false;
    state.logCache = {};
    state.cardErrors = {};
    updateRunningUI();
    switchView('view-dashboard');
    document.getElementById('chat-feed').innerHTML = '';
    planStreams.clear();
    agentStreams.clear();
    document.getElementById('flag-banner').classList.remove('visible');
    renderCards();
    updateDashboardMetrics();
    await loadChallenges();
    toast('All challenges and uploads reset.', 'success');
  });

  // Modal close buttons
  document.querySelectorAll('[data-close]').forEach(btn => {
    btn.addEventListener('click', () => closeModal(btn.dataset.close));
  });
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', e => {
      if (e.target === overlay) closeModal(overlay.id);
    });
  });
});

//  Helpers 
function switchView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function ts() {
  return new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function setDockerMenuOpen(open) {
  const menu = document.getElementById('docker-menu');
  const btn = document.getElementById('docker-status');
  if (!menu || !btn) return;
  menu.classList.toggle('open', !!open);
  btn.setAttribute('aria-expanded', open ? 'true' : 'false');
}

async function toggleDockerMenu() {
  const menu = document.getElementById('docker-menu');
  if (!menu) return;
  const opening = !menu.classList.contains('open');
  if (opening) await loadActiveContainers();
  setDockerMenuOpen(opening);
}

async function refreshLockUI() {
  const btn = document.getElementById('btn-lock-app');
  if (!btn) return;
  try {
    const s = await api('/api/auth/status');
    btn.style.display = (s && s.enabled && s.unlocked) ? '' : 'none';
  } catch {
    btn.style.display = 'none';
  }
}

function renderSecurityControls() {
  const pill = document.getElementById('settings-lock-status-pill');
  const toggle = document.getElementById('btn-security-toggle');
  const change = document.getElementById('btn-security-change');
  if (!pill || !toggle || !change) return;
  if (_securityEnabled) {
    pill.textContent = 'SECURITY ENABLED';
    pill.classList.add('on');
    pill.classList.remove('off');
    toggle.textContent = 'Disable Security';
    change.style.display = '';
  } else {
    pill.textContent = _securityPasswordSet ? 'SECURITY READY (OFF)' : 'SECURITY DISABLED';
    pill.classList.remove('on');
    pill.classList.add('off');
    toggle.textContent = 'Enable Security';
    change.style.display = _securityPasswordSet ? '' : 'none';
  }
}

function openSecurityModal(mode) {
  _securityAction = mode;
  const title = document.getElementById('security-modal-title');
  const subtitle = document.getElementById('security-modal-subtitle');
  const currentWrap = document.getElementById('security-current-wrap');
  const newWrap = document.getElementById('security-new-wrap');
  const confirmWrap = document.getElementById('security-confirm-wrap');
  const saveBtn = document.getElementById('btn-security-save');
  document.getElementById('security-current').value = '';
  document.getElementById('security-new').value = '';
  document.getElementById('security-confirm').value = '';

  if (mode === 'enable') {
    title.textContent = 'Enable Security';
    subtitle.textContent = 'Set a local password to lock and unlock the workspace.';
    currentWrap.style.display = 'none';
    newWrap.style.display = '';
    confirmWrap.style.display = '';
    saveBtn.textContent = 'Enable';
  } else if (mode === 'disable') {
    title.textContent = 'Disable Security';
    subtitle.textContent = 'Enter your current password to disable local security.';
    currentWrap.style.display = '';
    newWrap.style.display = 'none';
    confirmWrap.style.display = 'none';
    saveBtn.textContent = 'Disable';
  } else {
    title.textContent = 'Change Password';
    subtitle.textContent = 'Enter your current password and set a new one.';
    currentWrap.style.display = '';
    newWrap.style.display = '';
    confirmWrap.style.display = '';
    saveBtn.textContent = 'Change';
  }
  openModal('modal-security');
}

async function submitSecurityAction() {
  const current = document.getElementById('security-current').value;
  const next = document.getElementById('security-new').value;
  const confirm = document.getElementById('security-confirm').value;
  let body = {};
  let okMsg = 'Security updated.';

  if (_securityAction === 'enable') {
    body = { local_lock_enabled: true, new_password: next, confirm_password: confirm };
    okMsg = 'Security enabled.';
  } else if (_securityAction === 'disable') {
    body = { local_lock_enabled: false, current_password: current };
    okMsg = 'Security disabled.';
  } else if (_securityAction === 'change') {
    body = { local_lock_enabled: _securityEnabled, current_password: current, new_password: next, confirm_password: confirm };
    okMsg = 'Password changed.';
  } else {
    return;
  }

  const res = await api('/api/config', { method: 'POST', body });
  if (!res || res.error) {
    toast(res?.error || 'Security update failed.', 'error');
    return;
  }
  closeModal('modal-security');
  toast(okMsg, 'success');
  await loadSettings();
  await refreshLockUI();
}

function escHtml(str) {
  return sanitizeText(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

function sanitizeText(value) {
  let s = value == null ? '' : String(value);
  if (!s) return '';
  if (/[\\u00C3\\u00C2\\u00E2\\u00F0\\u00C5]/.test(s)) {
    try { s = decodeURIComponent(escape(s)); } catch {}
  }
  s = s
    .replace(/\u00E2\u20AC\u00A6|\u2026/g, '...')
    .replace(/\u00E2\u20AC\u201C|\u00E2\u20AC\u201D|\u2013|\u2014/g, '-')
    .replace(/\u00E2\u20AC\u00A2|\u2022/g, '*')
    .replace(/\u00C2/g, '');
  return s.replace(/[^\x09\x0A\x0D\x20-\x7E]/g, '');
}

//  Settings 
let _settingsClearOai = false;
let _settingsClearAnt = false;
let _securityEnabled = false;
let _securityPasswordSet = false;
let _securityAction = '';

async function loadSettings() {
  _settingsClearOai = false;
  _settingsClearAnt = false;
  const cfg = await api('/api/config');

  // OpenAI
  const oaiStatus = document.getElementById('oai-status');
  const oaiRemove = document.getElementById('oai-remove');
  const oaiInput  = document.getElementById('oai-key-input');
  oaiInput.value = '';
  if (cfg.openai_api_key_set) {
    oaiStatus.innerHTML = `
      <span class="key-badge set"><span class="key-dot"></span>SET</span>
      <span class="key-masked">${escHtml(cfg.openai_api_key_masked)}</span>`;
    oaiRemove.classList.add('visible');
  } else {
    oaiStatus.innerHTML = `<span class="key-badge unset"><span class="key-dot"></span>NOT SET</span>`;
    oaiRemove.classList.remove('visible');
  }

  // Anthropic
  const antStatus = document.getElementById('ant-status');
  const antRemove = document.getElementById('ant-remove');
  const antInput  = document.getElementById('ant-key-input');
  antInput.value = '';
  if (cfg.anthropic_api_key_set) {
    antStatus.innerHTML = `
      <span class="key-badge set"><span class="key-dot"></span>SET</span>
      <span class="key-masked">${escHtml(cfg.anthropic_api_key_masked)}</span>`;
    antRemove.classList.add('visible');
  } else {
    antStatus.innerHTML = `<span class="key-badge unset"><span class="key-dot"></span>NOT SET</span>`;
    antRemove.classList.remove('visible');
  }

  // Model
  document.getElementById('settings-model').value = cfg.model || '';
  _securityEnabled = !!cfg.local_lock_enabled;
  _securityPasswordSet = !!cfg.local_lock_password_set;
  renderSecurityControls();
  document.getElementById('settings-save-msg').style.display = 'none';
}

async function loadActiveContainers() {
  const list = document.getElementById('active-containers-list');
  if (!list) return;
  list.innerHTML = `<div class="containers-empty">Loading...</div>`;
  const res = await api('/api/docker/containers');
  if (!res || res.error) {
    list.innerHTML = `<div class="containers-empty">Failed to load containers.</div>`;
    return;
  }
  const rows = Array.isArray(res.containers) ? res.containers : [];
  if (!rows.length) {
    list.innerHTML = `<div class="containers-empty">No active challenge containers.</div>`;
    return;
  }
  list.innerHTML = rows.map(c => `
    <div class="container-row">
      <div class="container-meta">
        <div class="container-name">${escHtml(c.challenge_name || '(unknown)')}</div>
        <div class="container-sub">${escHtml(c.cid)}  ${escHtml(c.container_name)}  ${escHtml((c.status || '').toUpperCase())}</div>
      </div>
      <button class="container-open" data-open-cid="${escHtml(c.cid)}" data-open-manual="${c.manual_session ? '1' : '0'}">Open</button>
      <button class="container-kill" data-kill-cid="${escHtml(c.cid)}">Kill</button>
    </div>
  `).join('');
}

async function openChallengeFromContainerList(cid, isManual = false) {
  if (isManual) {
    const res = await api(`/api/challenges/${cid}/manual-start`, {
      method: 'POST',
      body: { open_terminal: true },
    });
    if (!res || res.error) {
      toast(res?.error || 'Failed to reopen manual terminal.', 'error');
      return;
    }
    setDockerMenuOpen(false);
    if (res.terminal_opened) {
      toast('Manual terminal reopened.', 'success');
    } else if (res.terminal_error) {
      toast(`Container is running, but terminal popup failed: ${res.terminal_error}`, 'error');
    } else {
      toast('Manual session container is ready.', 'success');
    }
    await checkDockerStatus();
    return;
  }
  setDockerMenuOpen(false);
  openChallenge(cid);
}

async function killContainerFromContainerList(cid) {
  if (!cid) return;
  const chal = state.challenges.find(c => c.id === cid);
  const label = chal?.name ? `"${chal.name}"` : cid;
  if (!confirm(`Kill container for ${label}?`)) return;
  const res = await api(`/api/challenges/${cid}/kill-container`, { method: 'POST', body: {} });
  if (!res || res.error) {
    toast(res?.error || 'Failed to kill container', 'error');
    return;
  }
  setDockerMenuOpen(false);
  toast('Container killed.', 'success');
  await loadActiveContainers();
  await checkDockerStatus();
  await loadChallenges();
  if (state.currentCid === cid) {
    await refreshCurrentChallenge();
  }
}

function toast(msg, type = 'info') {
  const container = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  const icon = type === 'success' ? 'OK' : type === 'error' ? 'ERR' : 'INFO';
  el.innerHTML = `<span>${icon}</span><span>${escHtml(sanitizeText(msg))}</span>`;
  container.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}
</script>
</body>
</html>





