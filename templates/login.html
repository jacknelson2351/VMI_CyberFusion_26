<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unlock - Big Stein</title>
<style>
:root {
  --bg: #1a1a1a;
  --bg1: #212121;
  --bg2: #2a2a2a;
  --border: #363636;
  --border2: #454545;
  --accent: #d97357;
  --text: #e8e8e8;
  --text-dim: #a0a0a0;
  --font-mono: ui-monospace, "SF Mono", "Fira Code", "Cascadia Code", monospace;
  --font-sans: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font-sans); }
body { display: grid; place-items: center; padding: 20px; }
.panel {
  width: min(420px, 94vw);
  background: var(--bg1);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 22px;
}
.title {
  font-family: var(--font-mono);
  color: var(--accent);
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 8px;
}
.subtitle {
  color: var(--text-dim);
  font-size: 13px;
  margin-bottom: 16px;
}
label {
  display: block;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  margin: 10px 0 6px;
}
input {
  width: 100%;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: 8px;
  color: var(--text);
  padding: 10px 12px;
  outline: none;
  font-family: var(--font-mono);
}
input:focus { border-color: var(--accent); }
button {
  width: 100%;
  margin-top: 14px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 12px;
  font-weight: 700;
  cursor: pointer;
}
button:disabled { opacity: 0.6; cursor: default; }
.msg {
  margin-top: 10px;
  min-height: 18px;
  font-size: 12px;
  color: #ff8d8d;
}
</style>
</head>
<body>
  <div class="panel">
    <div class="title">Welcome to the island...</div>
    <div class="subtitle" id="mode-text">Enter password to unlock the workspace.</div>
    <form id="unlock-form">
      <label id="password-label" for="password">PASSWORD</label>
      <input id="password" name="password" type="password" autocomplete="current-password" required>
      <div id="confirm-wrap" style="display:none;">
        <label for="confirm-password">CONFIRM PASSWORD</label>
        <input id="confirm-password" name="confirm-password" type="password" autocomplete="new-password">
      </div>
      <button type="submit" id="submit-btn">Unlock</button>
      <div class="msg" id="msg"></div>
    </form>
  </div>

<script>
const setupRequired = {{ 'true' if setup_required else 'false' }};
const form = document.getElementById('unlock-form');
const modeText = document.getElementById('mode-text');
const passwordLabel = document.getElementById('password-label');
const submitBtn = document.getElementById('submit-btn');
const msg = document.getElementById('msg');
const confirmWrap = document.getElementById('confirm-wrap');
const password = document.getElementById('password');
const confirmPassword = document.getElementById('confirm-password');

if (setupRequired) {
  modeText.textContent = 'Set your local lock password to initialize this workspace.';
  passwordLabel.textContent = 'NEW PASSWORD';
  submitBtn.textContent = 'Set Password';
  confirmWrap.style.display = '';
  password.autocomplete = 'new-password';
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  msg.textContent = '';
  submitBtn.disabled = true;
  try {
    const endpoint = setupRequired ? '/api/auth/setup' : '/api/auth/unlock';
    const body = setupRequired
      ? { password: password.value, confirm_password: confirmPassword.value }
      : { password: password.value };
    const r = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await r.json();
    if (!r.ok || data.error) {
      msg.textContent = data.error || 'Unlock failed.';
      submitBtn.disabled = false;
      return;
    }
    window.location.href = '/';
  } catch {
    msg.textContent = 'Unlock failed.';
    submitBtn.disabled = false;
  }
});
</script>
</body>
</html>
